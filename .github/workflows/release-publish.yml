# Tek workflow: Sürüm günceller, build alır, tag+release oluşturur, EXE'yi hem GitHub Release'e hem R2'ye yükler.
# Kullanım: Actions → Release: Create and Publish → Run workflow → version (örn. 1.1.3) gir → Run workflow

name: "Release: Create and Publish"

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Sürüm numarası (örn. 1.1.3)"
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Configure npm for GitHub Packages
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -n "$NPM_TOKEN" ]; then
            echo "@ai-music-corp:registry=https://npm.pkg.github.com/" >> .npmrc
            echo "//npm.pkg.github.com/:_authToken=$NPM_TOKEN" >> .npmrc
          fi

      - name: Set version in package.json
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          node -e "
            const fs = require('fs');
            const p = require('./package.json');
            p.version = process.env.VERSION;
            fs.writeFileSync('package.json', JSON.stringify(p, null, 2));
          "

      - name: Install dependencies
        run: npm ci

      - name: Build app bundle
        run: npm run build

      - name: Build Electron (dist)
        run: npm run dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Cloudflare R2
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          r2-bucket: ${{ secrets.R2_BUCKET }}
          source-dir: dist
          destination-dir: updates
          output-file-url: true

      - name: Commit version bump and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git diff --staged --quiet || git commit -m "chore: release v${{ github.event.inputs.version }}"
          git push

      - name: Create tag and push
        run: |
          TAG="v${{ github.event.inputs.version }}"
          git tag "$TAG"
          git push origin "$TAG"

      - name: Create GitHub Release and upload EXE/assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.event.inputs.version }}"
          TAG="v$VERSION"
          BODY="Release v$VERSION - AI Music Player"
          RESPONSE=$(curl -sS -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/releases" \
            -d "{\"tag_name\":\"$TAG\",\"name\":\"$TAG\",\"body\":\"$BODY\"}")
          UPLOAD_URL=$(echo "$RESPONSE" | jq -r '.upload_url' | sed 's/{.*$//')
          for f in dist/*.exe dist/*.yml; do
            [ -f "$f" ] || continue
            name=$(basename "$f")
            echo "Uploading $name to Release..."
            curl -sS -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/octet-stream" \
              --data-binary "@$f" \
              "${UPLOAD_URL}?name=$name"
          done
